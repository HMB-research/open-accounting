import{f as p,a as u,c as me}from"../chunks/CPI-Sj6W.js";import{p as fe,z as v,A as L,u as be,s as o,g as t,B as $t,C as a,E as r,a as ye,D as he,$ as xe,F as n,G as dt,K as ge,H as Ee,I as qe}from"../chunks/DZJbeXPm.js";import{s as _}from"../chunks/DRMUDMiI.js";import{i as U}from"../chunks/LXw8YH9d.js";import{e as ut,i as _t,s as Ot}from"../chunks/DksMkqyi.js";import{h as ze,r as pt,b as j}from"../chunks/D8iSYxBw.js";import{d as Ae,e as Re}from"../chunks/D1vpSegM.js";import{b as G,p as De}from"../chunks/BK0TuHnG.js";import{s as we,a as Ce}from"../chunks/CWTv1oOY.js";import{a as mt,D as Ht}from"../chunks/DOQewpRz.js";var Pe=p('<div class="alert alert-error"> </div>'),Ne=p("<p>Loading payments...</p>"),Ie=p('<div class="empty-state card svelte-zxnq2c"><p>No payments found. Record your first payment to get started.</p></div>'),Te=p('<tr><td class="number svelte-zxnq2c"> </td><td><span> </span></td><td> </td><td> </td><td> </td><td class="amount svelte-zxnq2c"> </td><td> </td><td class="reference svelte-zxnq2c"> </td></tr>'),Se=p('<div class="card"><table class="table"><thead><tr><th>Number</th><th>Type</th><th>Contact</th><th>Date</th><th>Method</th><th>Amount</th><th>Unallocated</th><th>Reference</th></tr></thead><tbody></tbody></table></div>'),ke=p("<option> </option>"),Fe=p("<option> </option>"),Me=p('<div class="allocation-row svelte-zxnq2c"><select class="input svelte-zxnq2c"><option>Select invoice...</option><!></select> <input class="input input-small svelte-zxnq2c" type="number" step="0.01" min="0" placeholder="Amount"/> <button type="button" class="btn btn-small btn-danger svelte-zxnq2c">&times;</button></div>'),Be=p('<div class="allocations-section svelte-zxnq2c"><h3 class="svelte-zxnq2c">Allocate to Invoices</h3> <!> <button type="button" class="btn btn-secondary btn-small svelte-zxnq2c">+ Add Invoice</button></div>'),$e=p('<div class="modal-backdrop svelte-zxnq2c" role="presentation"><div class="modal card svelte-zxnq2c" role="dialog" aria-modal="true" aria-labelledby="create-payment-title" tabindex="-1"><h2 id="create-payment-title" class="svelte-zxnq2c">Record Payment</h2> <form><div class="form-row svelte-zxnq2c"><div class="form-group svelte-zxnq2c"><label class="label" for="type">Payment Type</label> <select class="input" id="type"><option>Payment Received</option><option>Payment Made</option></select></div> <div class="form-group svelte-zxnq2c"><label class="label" for="contact">Contact</label> <select class="input" id="contact"><option>No contact</option><!></select></div></div> <div class="form-row svelte-zxnq2c"><div class="form-group svelte-zxnq2c"><label class="label" for="date">Payment Date</label> <input class="input" type="date" id="date" required/></div> <div class="form-group svelte-zxnq2c"><label class="label" for="amount">Amount *</label> <input class="input" type="number" step="0.01" min="0.01" id="amount" required/></div></div> <div class="form-row svelte-zxnq2c"><div class="form-group svelte-zxnq2c"><label class="label" for="method">Payment Method</label> <select class="input" id="method"><option>Bank Transfer</option><option>Cash</option><option>Card</option><option>Other</option></select></div> <div class="form-group svelte-zxnq2c"><label class="label" for="reference">Reference</label> <input class="input" type="text" id="reference" placeholder="Bank reference"/></div></div> <!> <div class="form-group"><label class="label" for="notes">Notes</label> <textarea class="input" id="notes" rows="2" placeholder="Additional notes..."></textarea></div> <div class="modal-actions svelte-zxnq2c"><button type="button" class="btn btn-secondary">Cancel</button> <button type="submit" class="btn btn-primary">Record Payment</button></div></form></div></div>'),Oe=p('<div class="container"><div class="header svelte-zxnq2c"><h1 class="svelte-zxnq2c">Payments</h1> <button class="btn btn-primary">+ New Payment</button></div> <div class="filters card svelte-zxnq2c"><div class="filter-row svelte-zxnq2c"><select class="input"><option>All Payments</option><option>Received</option><option>Made</option></select></div></div> <!> <!></div> <!>',1);function Xe(Vt,Kt){fe(Kt,!0);const ft=()=>we(De,"$page",Lt),[Lt,Ut]=Ce();let I=v(L([])),bt=v(L([])),yt=v(L([])),ht=v(!0),T=v(""),S=v(!1),xt=v(""),J=v("RECEIVED"),Q=v(""),W=v(L(new Date().toISOString().split("T")[0])),X=v("0"),Y=v("BANK_TRANSFER"),Z=v(""),tt=v(""),h=v(L([]));be(()=>{const e=ft().url.searchParams.get("tenant");e&&Tt(e)});async function Tt(e){o(ht,!0),o(T,"");try{const[s,i,d]=await Promise.all([mt.listPayments(e,{type:t(xt)||void 0}),mt.listContacts(e,{active_only:!0}),mt.listInvoices(e,{status:"SENT"})]);o(I,s,!0),o(bt,i,!0),o(yt,d,!0)}catch(s){o(T,s instanceof Error?s.message:"Failed to load data",!0)}finally{o(ht,!1)}}async function jt(e){e.preventDefault();const s=ft().url.searchParams.get("tenant");if(s)try{const i=await mt.createPayment(s,{payment_type:t(J),contact_id:t(Q)||void 0,payment_date:t(W),amount:t(X),payment_method:t(Y),reference:t(Z)||void 0,notes:t(tt)||void 0,allocations:t(h).filter(d=>d.invoice_id&&parseFloat(d.amount)>0)});o(I,[i,...t(I)],!0),o(S,!1),Gt()}catch(i){o(T,i instanceof Error?i.message:"Failed to create payment",!0)}}function Gt(){o(J,"RECEIVED"),o(Q,""),o(W,new Date().toISOString().split("T")[0],!0),o(X,"0"),o(Y,"BANK_TRANSFER"),o(Z,""),o(tt,""),o(h,[],!0)}function Jt(){o(h,[...t(h),{invoice_id:"",amount:"0"}],!0)}function Qt(e){o(h,t(h).filter((s,i)=>i!==e),!0)}async function Wt(){const e=ft().url.searchParams.get("tenant");e&&Tt(e)}const Xt={RECEIVED:"Payment Received",MADE:"Payment Made"},Yt={RECEIVED:"badge-received",MADE:"badge-made"},Zt={BANK_TRANSFER:"Bank Transfer",CASH:"Cash",CARD:"Card",OTHER:"Other"};function gt(e){const s=typeof e=="object"&&"toFixed"in e?e.toNumber():Number(e);return new Intl.NumberFormat("et-EE",{style:"currency",currency:"EUR"}).format(s)}function te(e){return new Date(e).toLocaleDateString("et-EE")}function ee(e){if(!e)return"-";const s=t(bt).find(i=>i.id===e);return(s==null?void 0:s.name)||"-"}function ae(e){const s=e.amount,i=e.allocations.reduce((d,x)=>d.plus(x.amount),new Ht(0));return new Ht(s).minus(i)}var St=Oe();ze("zxnq2c",e=>{he(()=>{xe.title="Payments - Open Accounting"})});var Et=$t(St),qt=r(Et),ne=a(r(qt),2);ne.__click=()=>o(S,!0),n(qt);var zt=a(qt,2),kt=r(zt),et=r(kt);et.__change=Wt;var At=r(et);At.value=At.__value="";var Rt=a(At);Rt.value=Rt.__value="RECEIVED";var Ft=a(Rt);Ft.value=Ft.__value="MADE",n(et),n(kt),n(zt);var Mt=a(zt,2);{var re=e=>{var s=Pe(),i=r(s,!0);n(s),dt(()=>_(i,t(T))),u(e,s)};U(Mt,e=>{t(T)&&e(re)})}var oe=a(Mt,2);{var se=e=>{var s=Ne();u(e,s)},le=e=>{var s=me(),i=$t(s);{var d=m=>{var b=Ie();u(m,b)},x=m=>{var b=Se(),R=r(b),k=a(r(R));ut(k,21,()=>t(I),_t,(at,c)=>{const D=qe(()=>ae(t(c)));var F=Te(),g=r(F),M=r(g,!0);n(g);var w=a(g),C=r(w),nt=r(C,!0);n(C),n(w);var E=a(w),B=r(E,!0);n(E);var q=a(E),$=r(q,!0);n(q);var z=a(q),O=r(z,!0);n(z);var P=a(z),rt=r(P,!0);n(P);var A=a(P);let H;var Dt=r(A,!0);n(A);var N=a(A),ot=r(N,!0);n(N),n(F),dt((st,wt,l,y,f)=>{_(M,t(c).payment_number),Ot(C,1,`badge ${Yt[t(c).payment_type]??""}`,"svelte-zxnq2c"),_(nt,Xt[t(c).payment_type]),_(B,st),_($,wt),_(O,Zt[t(c).payment_method||"OTHER"]||t(c).payment_method),_(rt,l),H=Ot(A,1,"amount svelte-zxnq2c",null,H,y),_(Dt,f),_(ot,t(c).reference||"-")},[()=>ee(t(c).contact_id),()=>te(t(c).payment_date),()=>gt(t(c).amount),()=>({"unallocated-warning":t(D).greaterThan(0)}),()=>gt(t(D))]),u(at,F)}),n(k),n(R),n(b),u(m,b)};U(i,m=>{t(I).length===0?m(d):m(x,!1)},!0)}u(e,s)};U(oe,e=>{t(ht)?e(se):e(le,!1)})}n(Et);var ie=a(Et,2);{var ve=e=>{var s=$e();s.__click=()=>o(S,!1);var i=r(s);i.__click=l=>l.stopPropagation();var d=a(r(i),2),x=r(d),m=r(x),b=a(r(m),2),R=r(b);R.value=R.__value="RECEIVED";var k=a(R);k.value=k.__value="MADE",n(b),n(m);var at=a(m,2),c=a(r(at),2),D=r(c);D.value=D.__value="";var F=a(D);ut(F,17,()=>t(bt),_t,(l,y)=>{var f=ke(),Ct=r(f,!0);n(f);var lt={};dt(()=>{_(Ct,t(y).name),lt!==(lt=t(y).id)&&(f.value=(f.__value=t(y).id)??"")}),u(l,f)}),n(c),n(at),n(x);var g=a(x,2),M=r(g),w=a(r(M),2);pt(w),n(M);var C=a(M,2),nt=a(r(C),2);pt(nt),n(C),n(g);var E=a(g,2),B=r(E),q=a(r(B),2),$=r(q);$.value=$.__value="BANK_TRANSFER";var z=a($);z.value=z.__value="CASH";var O=a(z);O.value=O.__value="CARD";var P=a(O);P.value=P.__value="OTHER",n(q),n(B);var rt=a(B,2),A=a(r(rt),2);pt(A),n(rt),n(E);var H=a(E,2);{var Dt=l=>{var y=Be(),f=a(r(y),2);ut(f,17,()=>t(h),_t,(lt,it,ce)=>{var Pt=Me(),vt=r(Pt),Nt=r(vt);Nt.value=Nt.__value="";var de=a(Nt);ut(de,17,()=>t(yt),_t,(V,ct)=>{var K=Fe(),_e=r(K);n(K);var Bt={};dt(pe=>{_(_e,`${t(ct).invoice_number??""} - ${pe??""}`),Bt!==(Bt=t(ct).id)&&(K.value=(K.__value=t(ct).id)??"")},[()=>gt(t(ct).total)]),u(V,K)}),n(vt);var It=a(vt,2);pt(It);var ue=a(It,2);ue.__click=()=>Qt(ce),n(Pt),G(vt,()=>t(it).invoice_id,V=>t(it).invoice_id=V),j(It,()=>t(it).amount,V=>t(it).amount=V),u(lt,Pt)});var Ct=a(f,2);Ct.__click=Jt,n(y),u(l,y)};U(H,l=>{t(yt).length>0&&l(Dt)})}var N=a(H,2),ot=a(r(N),2);ge(ot),n(N);var st=a(N,2),wt=r(st);wt.__click=()=>o(S,!1),Ee(2),n(st),n(d),n(i),n(s),Re("submit",d,jt),G(b,()=>t(J),l=>o(J,l)),G(c,()=>t(Q),l=>o(Q,l)),j(w,()=>t(W),l=>o(W,l)),j(nt,()=>t(X),l=>o(X,l)),G(q,()=>t(Y),l=>o(Y,l)),j(A,()=>t(Z),l=>o(Z,l)),j(ot,()=>t(tt),l=>o(tt,l)),u(e,s)};U(ie,e=>{t(S)&&e(ve)})}G(et,()=>t(xt),e=>o(xt,e)),u(Vt,St),ye(),Ut()}Ae(["click","change"]);export{Xe as component};
